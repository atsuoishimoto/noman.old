# pstack コマンド

実行中のプロセスのスタックトレースを表示します。

## 概要

`pstack`は実行中のプロセスにアタッチし、そのプロセス内のすべてのスレッドのスタックトレースを表示するユーティリティです。特にプログラムがハングしたり、過剰なリソースを消費している場合のデバッグに役立ちます。現在実行されている関数を表示することで問題の特定に役立ちます。

## オプション

`pstack`はシンプルなコマンドで、多くのオプションはありません。主にプロセスID（PID）を引数として受け取ります。

### **基本的な使い方**

```console
$ pstack PID
```

ここで`PID`は対象プロセスのプロセスIDです。

## 使用例

### 実行中のプロセスの調査

```console
$ pstack 1234
Thread 1 (process 1234):
#0  0x00007f8e2e2b7550 in poll () from /lib64/libc.so.6
#1  0x00007f8e2d8c3432 in ?? () from /lib64/libpthread.so.0
#2  0x000055c6a12b4e6a in main () at myprogram.c:42
```

### 複数のプロセスの調査

```console
$ pstack 1234 5678
==> 1234 <==
Thread 1 (process 1234):
#0  0x00007f8e2e2b7550 in poll () from /lib64/libc.so.6
#1  0x00007f8e2d8c3432 in ?? () from /lib64/libpthread.so.0
#2  0x000055c6a12b4e6a in main () at myprogram.c:42

==> 5678 <==
Thread 1 (process 5678):
#0  0x00007f8e2e2b7550 in read () from /lib64/libc.so.6
#1  0x000055c6a12b4e6a in process_data () at otherprogram.c:123
#2  0x000055c6a12b4f2b in main () at otherprogram.c:45
```

## ヒント:

### root権限が必要な場合がある

自分のユーザーに属していないプロセスを調査するには、root権限が必要な場合があります。そのような場合は`sudo pstack PID`を使用してください。

### 代替コマンド

一部のシステムでは`pstack`が利用できない場合があります。その場合は代替として`gdb -p PID -ex "thread apply all bt" -ex "quit"`を使用できます。

### 他の診断ツールと組み合わせる

包括的なデバッグのために、`pstack`を`top`、`ps`、`strace`などの他の診断ツールと一緒に使用すると効果的です。

### プロセスIDの検索

`pstack`を使用する前に、特定のプログラムのPIDを見つけるには`ps aux | grep プログラム名`を使用します。

## よくある質問

#### Q1. `pstack`は実際に何をするのですか？
A. `pstack`は実行中のプロセスにアタッチし、デバッグ情報を使用して各スレッドで現在実行されている関数の呼び出し階層を示すスタックトレースを生成します。

#### Q2. なぜ`pstack`の出力で一部の関数名が「??」と表示されるのですか？
A. これは通常、デバッグシンボルが不足している場合に発生します。プログラムがデバッグ情報なしでコンパイルされたか、シンボルが`pstack`が見つけられない別のファイルにある可能性があります。

#### Q3. どのプロセスでも`pstack`を使用できますか？
A. 適切な権限を持っているプロセスであれば、どのプロセスでも`pstack`を使用できます。通常、自分のプロセスは調査できますが、他のユーザーが所有するプロセスを調査するにはroot権限が必要です。

#### Q4. `pstack`はすべてのUnixシステムで利用可能ですか？
A. いいえ、`pstack`は標準のUnixユーティリティではありません。主にRed Hat系のLinuxシステムで一般的に見られます。他のシステムでは、`gdb`コマンドなどの代替手段を使用する必要があるかもしれません。

## 参考資料

https://man7.org/linux/man-pages/man1/pstack.1.html

## 改訂履歴

2025/05/04 初版作成