# until コマンド

条件が満たされるまでコマンドを繰り返し実行します。

## 概要

`until`コマンドはシェルの構文で、指定された条件が真になるまで一連のコマンドをループ実行します。`while`ループが条件が真である間継続するのに対し、`until`は条件が偽である間継続します。特定のイベントを待機したり、特定の状態に達するまでタスクを繰り返したりする場合に便利です。

## オプション

`until`コマンドは独立したプログラムではなくシェル組み込みの構文であるため、従来のコマンドラインオプションはありません。代わりに、特定の構文に従います：

```bash
until テスト・コマンド
do
  コマンド群
done
```

ここで：
- `テスト・コマンド`は各繰り返しの前に評価されます
- `コマンド群`は`テスト・コマンド`が非ゼロの終了ステータス（偽）を返す限り実行されます
- `テスト・コマンド`がゼロの終了ステータス（真）を返すとループは終了します

## 使用例

### 基本的な使い方

```console
$ count=1
$ until [ $count -gt 5 ]
> do
>   echo "カウントは $count です"
>   ((count++))
> done
カウントは 1 です
カウントは 2 です
カウントは 3 です
カウントは 4 です
カウントは 5 です
```

### ファイルが存在するまで待機

```console
$ until [ -f /tmp/ready.txt ]
> do
>   echo "ファイルが現れるのを待っています..."
>   sleep 5
> done
> echo "ファイルが存在します、続行します！"
ファイルが現れるのを待っています...
ファイルが現れるのを待っています...
ファイルが存在します、続行します！
```

### コマンドが成功するまで再試行

```console
$ until ping -c 1 example.com > /dev/null
> do
>   echo "サーバーが応答していません、5秒後に再試行します..."
>   sleep 5
> done
> echo "サーバーが起動しました！"
サーバーが応答していません、5秒後に再試行します...
サーバーが起動しました！
```

## ヒント:

### 早期終了にはbreakを使用

特定の条件が満たされた場合に`until`ループを早期に終了するには、`break`文を使用できます：

```bash
until [ 条件1 ]
do
  if [ 条件2 ]; then
    break
  fi
  コマンド群
done
```

### ポーリングにはsleepと組み合わせる

条件が真になるのを待つ場合は、過剰なCPU使用を避けるために`until`と`sleep`を組み合わせましょう：

```bash
until 確認用コマンド
do
  sleep 5  # チェック間に5秒待機
done
```

### 無限ループには注意

終了しない可能性のあるループを作成する際は注意が必要です。タイムアウトや最大繰り返し回数を追加することを検討してください：

```bash
count=0
max_tries=100
until [ 条件 ] || [ $count -ge $max_tries ]
do
  コマンド群
  ((count++))
done
```

## よくある質問

#### Q1. `until`と`while`の違いは何ですか？
A. `until`はテスト条件が偽である限りコマンドの実行を継続しますが、`while`は条件が真である限り継続します。つまり、`until [ 条件 ]`は`while ! [ 条件 ]`と同等です。

#### Q2. `until`で複数の条件を使用できますか？
A. はい、テストコマンド内で`&&`（AND）や`||`（OR）などの論理演算子を使用して複数の条件を組み合わせることができます。

#### Q3. 期待通りに動作しない`until`ループをデバッグするにはどうすればよいですか？
A. ループの前に`set -x`を追加してシェルデバッグを有効にすると、実行される各コマンドが表示されます。ループの後に`set +x`を使用してデバッグをオフにできます。

#### Q4. すべてのシェルで`until`を使用できますか？
A. `until`はbash、zsh、kshなどの多くの現代的なシェルで利用可能ですが、dashやashなどのより最小限のシェルでは利用できない場合があります。

## 参考資料

https://www.gnu.org/software/bash/manual/html_node/Looping-Constructs.html

## 改訂履歴

- 2025/05/04 初版作成