# set コマンド

シェルオプションと位置パラメータを表示または設定します。

## 概要

`set` コマンドはシェルオプションと位置パラメータを操作するために使用されます。すべての変数を表示したり、オプションの有効化や無効化によってシェルの動作を変更したり、位置パラメータを設定したりできます。シェル実行環境の制御やスクリプトのデバッグに役立つ強力なコマンドです。

## オプション

### **-e (--errexit)**

コマンドが非ゼロステータスで終了した場合、即座に終了します。

```console
$ set -e
$ non_existent_command
bash: non_existent_command: command not found
$ echo "これは実行されない"
[エラーによりシェルはすでに終了している]
```

### **-x (--xtrace)**

コマンドとその引数が実行される際に表示します。スクリプトのデバッグに便利です。

```console
$ set -x
$ echo "Hello World"
+ echo 'Hello World'
Hello World
```

### **-u (--nounset)**

未定義の変数を置換する際にエラーとして扱います。

```console
$ set -u
$ echo $UNDEFINED_VARIABLE
bash: UNDEFINED_VARIABLE: 未定義の変数です
```

### **-o オプション名**

オプション名に対応するオプションを設定します。

```console
$ set -o pipefail
$ non_existent_command | echo "これは実行される"
これは実行される
$ echo $?
127
```

### **+o オプション名**

オプション名に対応するオプションを解除します。

```console
$ set +o pipefail
$ non_existent_command | echo "これは実行される"
これは実行される
$ echo $?
0
```

### **--**

オプション処理を終了します。ダッシュで始まる位置パラメータを設定したい場合に便利です。

```console
$ set -- -a -b -c
$ echo $1 $2 $3
-a -b -c
```

## 使用例

### すべての変数と関数を表示する

```console
$ set
BASH=/bin/bash
BASHOPTS=checkwinsize:cmdhist:complete_fullquote:expand_aliases:...
...
[さらに多くの変数と関数]
```

### 位置パラメータを設定する

```console
$ set one two three
$ echo $1 $2 $3
one two three
```

### 複数のオプションを一度に有効にする

```console
$ set -ex
$ echo "コマンドがトレースされ、エラー時にスクリプトが終了します"
+ echo 'コマンドがトレースされ、エラー時にスクリプトが終了します'
コマンドがトレースされ、エラー時にスクリプトが終了します
```

### シェルオプションの保存と復元

```console
$ oldstate=$(set +o)
$ set -e
$ # 失敗する可能性のある処理を実行
$ eval "$oldstate"  # 以前の状態を復元
```

## ヒント:

### スクリプトで set -e を使用する

スクリプトの先頭に `set -e` を追加すると、エラーが発生した時点でスクリプトが失敗するため、デバッグが難しくなる連鎖的な障害を防ぐことができます。

### set -x でデバッグする

スクリプトが期待通りに動作しない場合、一時的に `set -x` を追加して、展開された変数を含む各コマンドの実行を確認できます。

### より堅牢なスクリプトのためにオプションを組み合わせる

`set -euo pipefail` の組み合わせは、エラー、未定義変数、パイプライン失敗時に失敗することでスクリプトをより堅牢にするために一般的に使用されます。

### 位置パラメータをリセットする

引数なしで `set --` を使用すると、すべての位置パラメータをクリアできます。

## よくある質問

#### Q1. `set` と `export` の違いは何ですか？
A. `set` はシェルオプションと位置パラメータを表示/変更しますが、`export` は変数を子プロセスで利用できるようにします。

#### Q2. setオプションをオフにするにはどうすればよいですか？
A. `-` の代わりに `+` 記号を使用します。例えば、`set +x` は `set -x` で有効にしたコマンドトレースをオフにします。

#### Q3. 現在設定されているオプションを確認するにはどうすればよいですか？
A. `set -o` を使用すると、すべてのシェルオプションの現在の状態を確認できます。

#### Q4. `set` を使って変数を作成できますか？
A. いいえ、`set` は通常の変数を作成しません。代わりに `VAR=value` のような変数代入を使用してください。`set` はシェルオプションと位置パラメータにのみ影響します。

## 参考資料

https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html

## 改訂履歴

- 2025/05/04 初版作成